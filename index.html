<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB Biology IA Research Question Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Tailwind's blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* For screen readers only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
    <script>
        // Immediately-invoked function to set theme on initial load to prevent flashing
        (function() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl relative">
        
        <!-- Theme Toggle Button -->
        <div class="absolute top-4 right-4 sm:top-6 sm:right-6">
            <button id="theme-toggle" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>

        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">IB Biology IA Research Question Generator</h1>
            <p class="mt-2 text-md sm:text-lg text-gray-600 dark:text-gray-400">Your starting point for a successful Internal Assessment</p>
        </header>

        <!-- Guide Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold mb-3 text-gray-700 dark:text-gray-300">What Makes a Good IA Research Question?</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-600 dark:text-gray-400">
                <li><strong class="font-medium text-gray-700 dark:text-gray-300">Focused & Specific:</strong> It should investigate a clear relationship between two variables.</li>
                <li><strong class="font-medium text-gray-700 dark:text-gray-300">Variables:</strong> It must contain a measurable Independent Variable (IV) and Dependent Variable (DV).</li>
                <li><strong class="font-medium text-gray-700 dark:text-gray-300">Feasible:</strong> It must be something you can realistically investigate in a school lab.</li>
                <li><strong class="font-medium text-gray-700 dark:text-gray-300">Formatted Correctly:</strong> Often framed as "To what extent does [IV] affect [DV]?".</li>
            </ul>
        </div>

        <!-- Input Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <label for="topicInput" class="sr-only">Enter a biology topic</label>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <input type="text" id="topicInput" class="flex-grow w-full px-4 py-3 mb-4 sm:mb-0 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter a biology topic (e.g., enzyme activity, osmosis, photosynthesis)...">
                <button id="generateBtn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-colors duration-200 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 3.8-3.8 1.9 3.8 1.9L12 14l1.9-3.8 3.8-1.9-3.8-1.9L12 3z"/><path d="M5 22v-2"/><path d="m5 14-1.9 3.8-3.8 1.9 3.8 1.9L5 22l1.9-3.8 3.8-1.9-3.8-1.9L5 14z"/><path d="M19 2v2"/><path d="m19 10 1.9-3.8 3.8-1.9-3.8-1.9L19 2l-1.9 3.8-3.8 1.9 3.8 1.9.1 0z"/></svg>
                    <span>Generate Questions</span>
                </button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results" class="space-y-4">
             <!-- Initial State Message -->
            <div id="initial-message" class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6" />
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-100">Ready to start your IA?</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Enter a topic above and we'll generate some research questions for you.</p>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-500 dark:text-gray-400">Generated with assistance from Gemini. Always verify IA topics with your teacher.</p>
        </footer>
        
        <!-- Message Box for copy confirmation -->
        <div id="messageBox" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300">
            Copied to clipboard!
        </div>

    </div>

    <script>
        const topicInput = document.getElementById('topicInput');
        const generateBtn = document.getElementById('generateBtn');
        const resultsDiv = document.getElementById('results');
        const messageBox = document.getElementById('messageBox');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Function to update theme toggle icons
        const updateThemeIcons = () => {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            } else {
                themeToggleDarkIcon.classList.add('hidden');
                themeToggleLightIcon.classList.remove('hidden');
            }
        };

        // Set initial state of theme icons
        updateThemeIcons();

        // Add event listener for theme toggle
        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcons();
        });

        // Function to show a temporary message
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'translate-y-10');
            }, 2000);
        }

        // Function to copy text to clipboard
        function copyToClipboard(text) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                showMessage('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy!');
            }
            document.body.removeChild(tempTextArea);
        }

        generateBtn.addEventListener('click', async () => {
            const topic = topicInput.value.trim();
            if (!topic) {
                resultsDiv.innerHTML = `<div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Oops!</strong>
                    <span class="block sm:inline">Please enter a topic to generate questions.</span>
                </div>`;
                return;
            }

            // Show loader
            resultsDiv.innerHTML = `<div class="flex justify-center items-center p-10"><div class="loader"></div></div>`;

            const prompt = `You are an expert IB Biology teacher specializing in Internal Assessments (IAs). A student is interested in the topic of '${topic}'. Generate 5 potential research questions for their IA. Each question must be in the format: 'To what extent does a change in [Independent Variable] affect the [Dependent Variable] in [Organism/System]?' The questions must be suitable for a standard high school biology lab, meaning they are safe, ethical, and use readily available materials. For each question, also provide a brief (1-2 sentence) suggestion for a possible methodology or key consideration. Return the response as a valid JSON object. The JSON object must contain a single key 'questions' which is an array of objects. Each object in the array must have two keys: 'question' (the research question string) and 'suggestion' (the methodology suggestion string).`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "questions": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "question": { "type": "STRING" },
                                        "suggestion": { "type": "STRING" }
                                    },
                                    required: ["question", "suggestion"]
                                }
                            }
                        },
                        required: ["questions"]
                    }
                }
            };
            
            const apiKey = ""; // API key will be provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);
                    displayResults(parsedData.questions);

                } else {
                    console.error('Unexpected API response structure:', result);
                    displayError('Could not generate questions. The model returned an unexpected response.');
                }

            } catch (error) {
                console.error('Error:', error);
                displayError('An error occurred while generating questions. Please check the console for details and try again.');
            }
        });
        
        // Fetch with exponential backoff for robustness
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 || response.status >= 500) { // Throttling or server error
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                    }
                }
                return response;
            } catch (error) {
                 if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        function displayResults(questions) {
            resultsDiv.innerHTML = '';
            if (!questions || questions.length === 0) {
                displayError('No questions were generated for this topic. Please try a different one.');
                return;
            }
            
            questions.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 transform hover:scale-[1.02] transition-transform duration-200';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2">${item.question}</h3>
                            <p class="text-gray-600 dark:text-gray-400"><strong class="font-medium text-gray-700 dark:text-gray-300">Suggestion:</strong> ${item.suggestion}</p>
                        </div>
                        <button class="copy-btn ml-4 p-2 flex-shrink-0 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600" title="Copy Question">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                `;
                
                const copyBtn = card.querySelector('.copy-btn');
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(item.question);
                });

                resultsDiv.appendChild(card);
            });
        }

        function displayError(message) {
            resultsDiv.innerHTML = `<div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline">${message}</span>
            </div>`;
        }
    </script>
</body>
</html>
